default_platform(:ios)

platform :ios do
  desc "Fetch certificates and provisioning profiles (readonly)"
  lane :fetch_certificates do
    match(
      type: "adhoc",
      readonly: true
    )
  end

  desc "Register new devices and regenerate profiles"
  lane :register_new_devices do |options|
    register_devices(
      devices_file: options[:devices_file] || "./devices.txt"
    )
    match(
      type: "adhoc",
      force: true
    )
  end

  desc "Sync devices from Firebase App Distribution and regenerate profiles"
  lane :sync_devices do |options|
    app_id = ENV["FIREBASE_IOS_APP_ID"]
    UI.user_error!("FIREBASE_IOS_APP_ID is required") unless app_id

    firebase_app_distribution_get_udids(
      app: app_id,
      output_file: "./devices.txt"
    )

    register_devices(
      devices_file: "./devices.txt"
    )

    match(
      type: "adhoc",
      force: true,
      keychain_name: options[:keychain_name],
      keychain_password: options[:keychain_password]
    )
  end
end
