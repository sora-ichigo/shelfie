# Implementation Plan

## Tasks

- [x] 0. API拡張（バックエンド）
- [x] 0.1 (P) myShelfクエリにページネーション・ソート・検索機能を追加する
  - MyShelfInput入力型を定義（query, sortBy, sortOrder, limit, offset）
  - ShelfSortField列挙型を定義（ADDED_AT, TITLE, AUTHOR）
  - SortOrder列挙型を定義（ASC, DESC）
  - MyShelfResult型を定義（items, totalCount, hasMore）
  - myShelfリゾルバを拡張して入力パラメータを処理
  - _Requirements: 3.5, 4.6, 13.4_

- [x] 0.2 myShelfクエリにcoverImageUrlを含める
  - UserBook型にcoverImageUrlフィールドを返却するように修正
  - _Requirements: 6.2_

- [ ] 1. ドメインモデルと列挙型の定義
- [x] 1.1 (P) ソート・グループ化オプションを定義する
  - 追加日（新しい順/古い順）、タイトル、著者名のソートオプションを列挙型で定義
  - グループ化なし、ステータス別、著者別のグループ化オプションを列挙型で定義
  - 各オプションに日本語ラベルを関連付ける
  - _Requirements: 4.5, 5.5_

- [x] 1.2 (P) 本棚表示用の書籍モデルを作成する
  - ユーザーの本棚エントリ情報（ID、タイトル、著者、読書状態、追加日など）を保持するイミュータブルモデルを定義
  - GraphQL レスポンスからモデルへの変換ファクトリを実装
  - カバー画像URLと評価はオプショナルフィールドとして定義（フェーズ1ではプレースホルダー）
  - _Requirements: 6.2, 6.3, 6.4, 6.5, 6.6_

- [x] 2. 状態管理の実装
- [x] 2.1 本棚画面の状態を定義する
  - 初期状態、ローディング中、読み込み完了、エラーの4つの状態をsealed classで定義
  - 読み込み完了状態には書籍リスト、検索クエリ、ソートオプション、グループ化オプションを保持
  - ページネーション用のhasMore、isLoadingMore、totalCountを状態に含める
  - グループ化された書籍マップも状態に含める
  - 空判定やhasSearchQueryヘルパーを追加
  - _Requirements: 10.1, 10.2, 11.1, 12.1, 13.1_
  - _Contracts: BookShelfState_

- [x] 2.2 本棚画面の状態管理Notifierを実装する
  - 初期化時にmyShelfクエリを実行して本棚データを取得（サーバーサイド検索・ソート・ページネーション対応）
  - 取得成功時はShelfStateへ同期し、読み込み完了状態へ遷移
  - 取得失敗時はエラー状態へ遷移（Failure型を使用）
  - 検索クエリ設定メソッドを実装（サーバーサイド検索、デバウンス適用）
  - ソートオプション設定メソッドを実装（サーバーサイドソート）
  - グループ化オプション設定メソッドを実装（クライアント側グルーピング）
  - loadMoreメソッドを実装（無限スクロール用、次のページを取得）
  - refreshメソッドを実装（最初のページから再取得）
  - _Requirements: 3.3, 3.4, 3.5, 4.4, 4.6, 5.4, 11.1, 11.2, 12.1, 12.2, 12.3, 13.1, 13.2, 13.3, 13.4, 13.5_
  - _Contracts: BookShelfNotifier API_

- [ ] 3. UI コンポーネントの実装
- [ ] 3.1 (P) 書籍カードコンポーネントを作成する
  - カバー画像を表示（画像がない場合はプレースホルダーアイコン）
  - 星評価を5段階で表示（未評価時は空表示）
  - タイトルを最大2行で表示し、超過分は省略記号で切り詰め
  - 著者名を最大1行で表示し、超過分は省略記号で切り詰め
  - タップ時のコールバックを受け取り、視覚的フィードバックを提供
  - ダークテーマに準拠したカードデザイン
  - _Requirements: 6.2, 6.3, 6.4, 6.5, 6.6, 6.7, 7.1, 9.1, 9.3_

- [ ] 3.2 書籍グリッドコンポーネントを作成する
  - 3列固定のグリッドレイアウトで書籍カードを配置
  - スクロール可能なリストとして実装（遅延レンダリング対応）
  - グループ化表示時はセクションヘッダーを挿入
  - セクションヘッダーにはグループ名（ステータス名または著者名）を表示
  - 無限スクロール対応（リスト末尾付近でloadMoreコールバックを発火）
  - 追加読み込み中はリスト末尾にローディングインジケーターを表示
  - _Requirements: 6.1, 13.1, 13.2, 13.3_

- [ ] 3.3 検索・フィルターバーコンポーネントを作成する
  - 検索バーに虫眼鏡アイコンと「本を検索...」プレースホルダーを表示
  - 検索入力時は300msのデバウンスを適用してコールバックを発火
  - ソート選択ドロップダウンを配置し、4つのオプションを表示
  - デフォルトで「追加日（新しい順）」を選択状態
  - グループ化選択ドロップダウンを配置し、3つのオプションを表示
  - デフォルトで「すべて」を選択状態
  - _Requirements: 3.1, 3.2, 4.1, 4.2, 4.3, 5.1, 5.2, 5.3_

- [ ] 4. メイン画面の実装
- [ ] 4.1 本棚画面のレイアウトを構築する
  - SafeAreaでラップしたColumnレイアウトを構成
  - 既存のScreenHeaderコンポーネントで「本棚」タイトルとプロフィールアイコンを表示
  - プロフィールアイコンタップ時にプロフィール画面へ遷移
  - 検索・フィルターバーをヘッダー下に配置
  - _Requirements: 1.1, 1.2, 1.3_

- [ ] 4.2 状態に応じた画面表示を実装する
  - ローディング状態ではLoadingIndicatorを全画面表示（ユーザー操作はブロックしない）
  - 読み込み完了かつ書籍0件では空状態UIを表示（アイコン＋ガイダンスメッセージ）
  - 読み込み完了かつ書籍ありでは書籍グリッドを表示
  - 検索結果0件では「検索結果が見つかりません」メッセージを表示
  - エラー状態ではエラーメッセージとリトライボタンを表示
  - リトライボタンタップでデータ再取得を実行
  - _Requirements: 3.4, 10.1, 10.2, 11.1, 11.2, 12.1, 12.2, 12.3_

- [ ] 4.3 書籍詳細画面への遷移を実装する
  - 書籍カードタップ時にgo_routerで詳細画面へプッシュ遷移
  - 書籍のexternalIdをパラメータとして渡す
  - _Requirements: 7.1_

- [ ] 5. ルーター統合とテーマ適用
- [ ] 5.1 ルーター設定を更新する
  - 既存の_HomeScreenプレースホルダーを本棚画面に置き換え
  - ボトムナビゲーションの「本棚」タブで本棚画面を表示
  - 本棚画面表示中は「本棚」タブを選択状態に維持
  - 「検索」タブタップで検索画面へ遷移
  - _Requirements: 8.1, 8.2, 8.3, 8.4_

- [ ] 5.2 デザインテーマの適用を確認する
  - ダークテーマ（黒背景）が全コンポーネントに適用されていることを確認
  - アクセントカラー（緑色）が適切な箇所で使用されていることを確認
  - カードUIがモダンなデザインになっていることを確認
  - _Requirements: 9.1, 9.2, 9.3_

- [ ] 6. テストの実装
- [ ] 6.1 (P) 状態管理のユニットテストを作成する
  - 初期化時のデータ取得と状態遷移をテスト
  - 検索クエリ変更時のサーバーリクエストをテスト
  - ソートオプション変更時のサーバーリクエストをテスト
  - 各グループ化オプションによるクライアント側グルーピング結果をテスト
  - loadMoreによるページネーションをテスト
  - エラー発生時の状態遷移をテスト
  - _Requirements: 3.3, 3.5, 4.4, 4.6, 5.4, 11.1, 12.1, 13.1, 13.4_

- [ ] 6.2 (P) UIコンポーネントのウィジェットテストを作成する
  - 書籍カードの表示内容（画像、評価、タイトル、著者名の省略）をテスト
  - 書籍グリッドの3列レイアウトをテスト
  - 検索バーの入力とデバウンス動作をテスト
  - ドロップダウンの選択状態をテスト
  - 無限スクロール時のローディングインジケーター表示をテスト
  - _Requirements: 3.1, 3.2, 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 6.7, 13.3_

- [ ] 6.3 本棚画面の状態表示テストを作成する
  - ローディング状態の表示をテスト
  - 空状態の表示をテスト
  - エラー状態とリトライボタンの表示をテスト
  - 書籍一覧の表示をテスト
  - _Requirements: 10.1, 10.2, 11.1, 12.1, 12.2, 12.3_

- [ ] 6.4 インテグレーションテストを作成する
  - 本棚画面表示から検索実行までのフローをテスト
  - ソート変更による並び順変更をテスト
  - 無限スクロールによる追加読み込みをテスト
  - 書籍タップから詳細画面遷移までのフローをテスト
  - エラー発生からリトライによる正常表示までのフローをテスト
  - _Requirements: 3.3, 4.4, 7.1, 12.3, 13.1, 13.2_
