# Implementation Plan

## Task 1: API側Infraレイヤの構築

- [x] 1.1 (P) 画像アップロードサービスの抽象インターフェースを定義する
  - 署名付きアップロードパラメータを返却するインターフェースを作成
  - エラー型（設定エラー、サービス利用不可）を定義
  - Result型を使用したエラーハンドリングを実装
  - _Requirements: 3.1, 3.2_

- [x] 1.2 ImageKit SDKを使用した署名生成クライアントを実装する
  - imagekit npmパッケージをインストール
  - 環境変数からImageKit認証情報（Public Key, Private Key, URL Endpoint）を取得
  - getAuthenticationParametersを使用して署名付きパラメータを生成
  - 署名の有効期限（30分）を設定
  - 接続失敗時のエラーログ出力とエラーレスポンスを実装
  - 1.1で定義したインターフェースに準拠した実装
  - _Requirements: 3.2, 3.3, 3.4_

- [x] 1.3 Infraレイヤのユニットテストを作成する
  - 署名付きパラメータ生成の正常系テスト
  - 環境変数未設定時のエラーハンドリングテスト
  - ImageKit SDK連携のモックテスト
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

## Task 2: GraphQL APIの実装

- [x] 2.1 署名付きアップロードパラメータ取得のGraphQL Queryを実装する
  - UploadCredentials型をGraphQLスキーマに追加
  - getUploadCredentials Queryを実装
  - 認証スコープ（loggedIn）を設定
  - Infraレイヤのサービスを呼び出して署名付きパラメータを返却
  - 認証エラー、サービスエラーのハンドリングを実装
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [x] 2.2 GraphQL Queryの統合テストを作成する
  - 認証済みユーザーでの正常系テスト
  - 未認証ユーザーでの認証エラーテスト
  - サービスエラー時のレスポンステスト
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

## Task 3: モバイルアプリのアップロードサービス構築

- [x] 3.1 (P) 画像バリデーション機能を実装する
  - JPEG、PNG、WebP形式のMIMEタイプ検証
  - ファイルサイズ制限（5MB）のチェック
  - バリデーション結果とエラータイプの返却
  - 未対応形式、サイズ超過時のエラーメッセージ定義
  - _Requirements: 1.3, 1.4, 1.5_

- [x] 3.2 署名付きパラメータ取得のGraphQLクエリを追加する
  - getUploadCredentials QueryをFerryスキーマに追加
  - コード生成を実行してDart型を生成
  - AccountRepositoryに署名取得メソッドを追加
  - _Requirements: 2.1_

- [x] 3.3 ImageKitへのマルチパートアップロード機能を実装する
  - http packageを使用したMultipartRequest構築
  - 署名付きパラメータをフォームフィールドに設定
  - 画像ファイルをマルチパートファイルとして添付
  - アップロード進捗のコールバック対応
  - アップロード成功時の配信URL取得
  - アップロード失敗時のエラーハンドリングとリトライ対応
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [x] 3.4 アップロードからプロフィール更新までのオーケストレーションを実装する
  - バリデーション、署名取得、アップロード、プロフィール更新の一連フローを統合
  - 各ステップでのエラーハンドリング
  - Either型を使用した明示的なエラー伝播
  - _Requirements: 4.1, 5.1_

- [x] 3.5 アップロードサービスのユニットテストを作成する
  - 画像バリデーションのテスト（形式、サイズ）
  - アップロードフローのモックテスト
  - エラーケースのテスト
  - _Requirements: 1.3, 1.4, 1.5, 4.1, 4.2, 4.3, 4.4_

## Task 4: プロフィール編集UIの拡張

- [x] 4.1 画像選択機能をプロフィール編集画面に統合する
  - 既存のImagePickerServiceを使用した画像選択トリガー
  - アバター変更ボタンのタップハンドリング
  - 選択画像のプレビュー表示
  - バリデーションエラー時のメッセージ表示
  - _Requirements: 1.1, 1.2, 1.3, 1.5_

- [x] 4.2 アップロード中の状態管理とUI表示を実装する
  - ProfileEditNotifierにアップロード状態を追加
  - プログレスインジケーターの表示
  - アップロード中の操作無効化
  - 成功時のUI更新
  - 失敗時のエラーメッセージとリトライボタン表示
  - _Requirements: 4.2, 4.3, 5.3, 5.4_

- [x] 4.3 プロフィール更新処理を拡張する
  - 保存ボタンタップ時にアバターアップロードフローを実行
  - アップロード成功後にプロフィール更新APIを呼び出し
  - avatarUrlをサーバーに送信
  - 更新成功時のUI反映
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [x] 4.4 プロフィール編集画面のウィジェットテストを作成する
  - 画像選択UIの表示テスト
  - プレビュー表示のテスト
  - エラーメッセージ表示のテスト
  - _Requirements: 1.1, 1.2, 1.3, 1.5_

## Task 5: アバター画像表示機能の拡張

- [x] 5.1 (P) UserAvatarウィジェットにImageKit URL変換を実装する
  - ImageKit URL変換パラメータの適用（サイズ最適化）
  - 表示サイズに応じた画像取得
  - tr=w-{size},h-{size},fo-faceパラメータの構築
  - _Requirements: 6.4_

- [x] 5.2 アバター画像の読み込み状態管理を実装する
  - 読み込み中のプレースホルダー表示
  - 取得失敗時のデフォルトアバター表示
  - URLがnullの場合のフォールバック
  - _Requirements: 6.1, 6.2, 6.3_

- [x] 5.3 UserAvatarウィジェットのテストを作成する
  - URL有無による表示切り替えテスト
  - ローディング状態のテスト
  - エラー状態のデフォルト表示テスト
  - _Requirements: 6.1, 6.2, 6.3, 6.4_

## Task 6: 統合と検証

- [x] 6.1 エンドツーエンドの統合テストを実施する
  - 画像選択からアップロード、プロフィール保存、表示までの完全フロー検証
  - API側とモバイル側の連携確認
  - 各種エラーケースの動作確認
  - _Requirements: 1.1, 1.2, 2.1, 4.1, 4.4, 5.1, 5.4, 6.1_

- [x] 6.2 環境変数設定とインフラ構成を完了する
  - ImageKit認証情報の環境変数設定（開発・本番）
  - .env.exampleへのテンプレート追加
  - ConfigManagerへのImageKit設定追加
  - _Requirements: 3.3_
