# Implementation Plan

- [ ] 1. バックエンド API の認可変更
- [x] 1.1 (P) 本検索・本詳細クエリの公開化
  - searchBooks、searchBookByISBN、bookDetail の 3 クエリから認証スコープ制約を削除し、未認証リクエストでも実行可能にする
  - bookDetail は未認証時に userBook フィールドを null として返すことを確認する（既存ロジックで対応済み）
  - 他のクエリ・ミューテーションの認証スコープは一切変更しない
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [x] 1.2 (P) 保護対象操作の認証維持を検証するテスト
  - 未認証リクエストで searchBooks、searchBookByISBN、bookDetail が成功することを検証する統合テストを追加する
  - 未認証リクエストで bookDetail の userBook が null であることを検証する
  - 未認証リクエストで addBookToShelf、myShelfPaginated 等の保護対象操作が UNAUTHENTICATED エラーを返すことを検証する
  - 全ミューテーション・保護対象クエリの認証スコープが維持されていることを確認する
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 5.7, 5.8_

- [ ] 2. 認証状態のゲストモード対応（コア層）
- [x] 2.1 AuthStateData にゲストモードフラグを追加する
  - 認証状態データクラスに isGuest フラグを追加し、デフォルトを false にする
  - isAuthenticated と isGuest が排他的であること（両方 true にならない）を保証する
  - isGuest が true の場合、userId・email・token・refreshToken は全て null であることを保証する
  - 初期状態・ゲスト状態・認証済み状態の 3 パターンの状態遷移をユニットテストで検証する
  - _Requirements: 2.1, 2.2_

- [x] 2.2 SecureStorageService にゲストモード永続化機能を追加する
  - ゲストモードフラグの保存・読み込み・クリアの 3 メソッドを既存のストレージサービスに追加する
  - 既存の認証データ管理メソッドには影響を与えない
  - 保存・読み込み・クリアのユニットテストを追加する
  - タスク 2.1 の AuthStateData が完了している必要がある
  - _Requirements: 2.3_

- [x] 2.3 AuthState にゲストモード開始・復元・解除ロジックを追加する
  - ゲストモード開始メソッドを実装し、isGuest を true に設定してストレージに永続化する
  - セッション復元時に認証データを優先的に確認し、なければゲストモードフラグを確認する復元ロジックを実装する
  - ログイン/登録完了時にゲストモードフラグをストレージからクリアし、認証済み状態に遷移するロジックを実装する
  - ログアウト時にゲストモードフラグと本棚データの両方をクリアする
  - 認証済み状態への移行時に本棚データとリストデータの再取得をトリガーする
  - 各状態遷移パス（初期->ゲスト、ゲスト->認証済み、認証済み->初期、ゲスト->初期）のユニットテストを追加する
  - セッション復元の 3 パターン（認証データあり、ゲストフラグあり、いずれもなし）のユニットテストを追加する
  - タスク 2.1、2.2 が完了している必要がある
  - _Requirements: 1.2, 2.2, 2.3, 2.4, 8.2, 8.3, 9.4_

- [ ] 3. ルーティングガードのゲストモード対応
- [x] 3.1 guardRoute にゲストモード時のルート判定ロジックを追加する
  - ゲスト許可ルート（ホーム、検索、本詳細、ウェルカム、認証系）へのアクセスを許可する
  - ゲスト不可ルート（アカウント系、リスト系）へのアクセスをウェルカム画面にリダイレクトする
  - 認証済みユーザーの既存リダイレクトルールを維持する
  - 判定優先順位（認証済み -> ゲスト許可 -> ゲスト不可 -> 未認証）を正しく実装する
  - 全ルートパターンとユーザー状態の組み合わせ（ゲスト+許可ルート、ゲスト+不可ルート、認証済み、未認証）のユニットテストを追加する
  - タスク 2.1 の AuthStateData 変更が完了している必要がある
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 8.4_

- [ ] 4. ウェルカム画面のゲストモード対応
- [x] 4.1 ウェルカム画面に「アカウントなしで利用」リンクを追加する
  - ログインボタン・新規登録ボタンの下に「アカウントなしで利用」テキストリンクを追加する
  - リンクはボタンよりも控えめなスタイル（テキストリンク形式）で表示する
  - コールバックを上位ウィジェットまで伝播する仕組みを構築する
  - タスク 2.3 の AuthState ゲストモード開始メソッドが完了している必要がある
  - _Requirements: 1.1, 1.3_

- [x] 4.2 ウェルカム画面のゲストモード開始オーケストレーションを実装する
  - 「アカウントなしで利用」タップ時にゲストモード開始メソッドを呼び出し、検索タブ画面へ遷移する
  - 既にゲストモード中の場合は元の画面に戻る動作を実装する
  - ログイン・登録ボタンは通常通り表示する
  - _Requirements: 1.2, 8.1, 8.5_

- [ ] 5. ゲストモード時の UI 制限と非表示対応
- [x] 5.1 (P) 本詳細画面にゲストモード時の操作制限を追加する
  - ゲストユーザーが「本棚に追加」ボタンをタップした時にウェルカム画面を表示する
  - ゲストユーザーが読書ステータス変更操作をタップした時にウェルカム画面を表示する
  - ゲストユーザーが評価・メモ操作をタップした時にウェルカム画面を表示する
  - ゲストモード時は本棚状態の監視をスキップし、未登録状態として扱う
  - _Requirements: 6.1, 6.2, 6.3_

- [x] 5.2 (P) 本棚画面にゲストモード時のログイン促進表示を追加する
  - ゲストモード時は本棚データ・リストデータのロードをスキップする
  - 代わりにログインを促すメッセージウィジェットをログインボタン付きで表示する
  - リスト作成・リスト詳細への導線を非表示にする
  - _Requirements: 6.4, 7.3, 9.1, 9.2_

- [x] 5.3 (P) 検索画面にゲストモード時の ISBN スキャン制限を追加する
  - ゲストユーザーが ISBN スキャンボタンをタップした時にウェルカム画面を表示する
  - テキスト検索機能はゲストユーザーでも通常通り利用可能にする
  - _Requirements: 6.5_

- [x] 5.4 (P) ヘッダーにゲストモード時のアカウントアイコン非表示を追加する
  - ゲストモード時にアバターアイコン領域を非表示にする制御パラメータを追加する
  - 各画面からゲスト判定結果を渡す仕組みを実装する
  - _Requirements: 7.2_

- [x] 5.5 (P) ナビゲーションバーのゲストモード制御を追加する
  - ホームタブ（ライブラリ）のアイコンとラベルは表示を維持する
  - ホームタブタップ時にゲストモードであればホーム画面内でログイン促進を表示する
  - _Requirements: 7.1_

- [ ] 6. データクリーンアップとトークン制御
- [x] 6.1 ゲストモード時の GraphQL リクエストからトークンを除外する
  - ゲストモード時に認証トークンを含まない GraphQL リクエストを送信することを確認する
  - 既存の認証リンクのトークン省略ロジックがゲストモードでも正しく機能することを検証する
  - _Requirements: 9.3_

- [x] 6.2 認証済み移行時のデータ再取得を検証する
  - ゲストモードから認証済み状態に移行した時に本棚データとリストデータが新たにロードされることを確認する
  - ShelfVersion / BookListVersion による状態伝播パターンが移行後に正しく機能することを検証する
  - _Requirements: 9.4_

- [ ] 7. 統合テストと動作検証
- [x] 7.1 ウェルカム画面のゲストモード開始ウィジェットテスト
  - 「アカウントなしで利用」リンクの表示とコールバック発火を検証する
  - ゲストモード開始後に検索タブへ遷移することを検証する
  - 既にゲストモード中のウェルカム画面表示で元の画面に戻ることを検証する
  - _Requirements: 1.1, 1.2, 1.3, 8.1, 8.5_

- [x] 7.2 ゲストモード時の UI 制限ウィジェットテスト
  - 本棚画面でゲストモード時にログイン促進メッセージが表示されることを検証する
  - 本詳細画面でゲストモード時の操作ボタンタップでウェルカム画面遷移が発生することを検証する
  - ヘッダーでゲストモード時にアバターアイコンが非表示になることを検証する
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 7.2, 7.3_
