# Implementation Plan

- [ ] 1. プロジェクトセットアップとプラットフォーム設定
  - `gal` パッケージを依存関係に追加し、iOS の Info.plist に `NSPhotoLibraryAddUsageDescription` を追加する
  - Android の AndroidManifest.xml に SDK <= 29 向けの `WRITE_EXTERNAL_STORAGE` パーミッションを追加する
  - `features/book_share/` ディレクトリ構造（application / domain / infrastructure / presentation）を作成する
  - _Requirements: 5.1, 5.2_

- [ ] 2. ドメインモデルとカードレベル判定ロジック
- [ ] 2.1 (P) カードレベルとカードデータのドメイン型を定義する
  - カードの3段階（シンプル / プロフィール付き / 感想共有）を表す列挙型を作成する
  - カード描画に必要なデータ（タイトル、著者名、表紙 URL、ユーザー名、アバター URL、星評価、読了日、読書メモ）を集約する freezed クラスを作成する
  - build_runner でコード生成を実行する
  - _Requirements: 2.1, 2.2, 2.3_

- [ ] 2.2 カードレベルの状態管理と利用可否判定を実装する
  - Riverpod Notifier でカードレベルの状態（現在のレベル、利用可能レベル一覧、カードデータ）を管理する
  - ShelfEntry の rating 有無でプロフィール付きカードの利用可否を判定する
  - ShelfEntry の note 有無で感想共有カードの利用可否を判定する
  - デフォルトはシンプルカードを選択し、利用可能レベルの範囲内でのみ切り替えを許可する
  - BookDetail と ShelfEntry からカードデータを読み取り専用で参照し、データ集約型に変換する
  - ユーザープロフィール情報（名前、アバター URL）を取得して集約する
  - 2.1 のドメイン型に依存するため順次実行
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_

- [ ] 2.3 カードレベル判定ロジックのユニットテストを作成する
  - rating ありの場合にプロフィール付きレベルが利用可能であることを検証する
  - rating なしの場合にプロフィール付きレベルが利用不可であることを検証する
  - note ありの場合に感想共有レベルが利用可能であることを検証する
  - note なし（null または空文字）の場合に感想共有レベルが利用不可であることを検証する
  - レベル切り替えが利用可能レベルの範囲内に制限されることを検証する
  - デフォルトでシンプルカードが選択されることを検証する
  - 2.2 の Notifier 実装に依存するため順次実行
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_

- [ ] 3. 読了カード Widget の描画
- [ ] 3.1 (P) シンプルカード（デフォルト）を描画する Widget を実装する
  - 表紙画像、タイトル、著者名、Shelfie ロゴを含む 1:1 レイアウトを構築する
  - 論理サイズ 360x360 で構築し、RepaintBoundary でラップする
  - 表紙画像は CachedNetworkImage で表示し、null の場合は書籍アイコンのプレースホルダーを表示する
  - 既存のデザインシステム（AppColors, AppSpacing）を適用する
  - ダークモードのみ対応する
  - _Requirements: 2.1, 2.6, 2.7, 4.3_

- [ ] 3.2 プロフィール付きカードと感想共有カードの描画を追加する
  - シンプルカードにユーザーアイコン、星評価、読了日を追加したプロフィール付きレイアウトを実装する
  - プロフィール付きカードに読書メモを追加した感想共有レイアウトを実装する
  - カードレベルに応じて表示内容を切り替える仕組みを構築する
  - 3.1 のシンプルカード Widget に依存するため順次実行
  - _Requirements: 2.2, 2.3, 2.6_

- [ ] 3.3* カード Widget の表示要素をウィジェットテストで検証する
  - シンプルカードで表紙、タイトル、著者名、ロゴが表示されることを検証する
  - プロフィール付きカードでユーザーアイコン、星評価、読了日が追加表示されることを検証する
  - 感想共有カードで読書メモが追加表示されることを検証する
  - 表紙画像が null の場合にプレースホルダーが表示されることを検証する
  - _Requirements: 2.1, 2.2, 2.3, 2.6, 2.7_

- [ ] 4. 画像キャプチャとシェア基盤
- [ ] 4.1 (P) Widget をキャプチャして PNG 変換し、OS シェアシートを呼び出すサービスを実装する
  - RepaintBoundary の GlobalKey を受け取り、RenderRepaintBoundary.toImage() で ui.Image にキャプチャする
  - PNG バイトデータに変換し、一時ディレクトリに書き出す
  - share_plus の最新 API（SharePlus.instance.share(ShareParams(...))）で OS シェアシートを呼び出す
  - iPad 対応のため sharePositionOrigin を必ず渡す
  - キャプチャ専用メソッド（シェアシートなしで PNG バイトデータのみ返す）も提供する
  - pixelRatio 3.0 で 1080x1080 の高品質 PNG を生成する
  - レンダリング未完了時やキャプチャ失敗時は Either の Left（Failure）を返す
  - シェア完了後に一時ファイルを削除する
  - _Requirements: 4.1, 4.2_

- [ ] 4.2 (P) フォトライブラリ保存サービスを実装する
  - gal パッケージを使用してフォトライブラリへの画像保存を行う
  - パーミッション確認（Gal.hasAccess）と自動リクエスト（Gal.requestAccess）を管理する
  - 保存結果を成功 / パーミッション拒否 / エラーの3種類で返す
  - パーミッション永続拒否時は呼び出し元に伝えて設定画面への誘導を可能にする
  - _Requirements: 5.1, 5.2_

- [ ] 5. プレビュー画面とユーザー操作
- [ ] 5.1 カードプレビュー画面のレイアウトとアクションバーを実装する
  - シェアボタン、保存ボタン、戻るボタンを含むアクションバーを構築する
  - カード Widget をプレビューとして中央に表示する
  - go_router にルートを追加し、書籍詳細画面からの遷移パラメータ（externalId, source）を受け取る
  - シェアと保存の同時実行を防ぐガードを設ける
  - _Requirements: 3.1, 3.2_

- [ ] 5.2 カードレベル切り替え UI を実装する
  - 利用可能なカードレベルに応じたセグメントコントロールまたはタブ UI を構築する
  - 上位レベルが利用不可の場合は切り替えオプションを非表示にする
  - レベル切り替え時にプレビュー画像を即座に更新する
  - 5.1 のプレビュー画面に依存するため順次実行
  - _Requirements: 3.3, 3.4_

- [ ] 5.3 シェア・保存実行とエラーハンドリングを実装する
  - シェアボタンタップ時に画像キャプチャとシェアシート表示を実行する
  - 保存ボタンタップ時に画像キャプチャとフォトライブラリ保存を実行する
  - シェア・保存中はローディング状態を表示する
  - 保存成功時に完了通知の SnackBar を表示する
  - シェアエラーや保存エラー時にエラーメッセージの SnackBar を表示し、再試行できるようにする
  - パーミッション拒否時に設定画面への誘導メッセージを表示する
  - 処理中に画面離脱した場合の mounted チェックを行う
  - 5.1, 5.2 のプレビュー画面に依存するため順次実行
  - _Requirements: 4.4, 5.3, 5.4_

- [ ] 6. 書籍詳細画面へのシェア導線追加
- [ ] 6.1 読了状態の書籍にシェアボタンを表示する
  - 書籍詳細画面の AppBar actions または本文中に、読了状態の書籍に対してシェアアイコンボタンを追加する
  - 読了でない書籍にはシェアボタンを非表示にする条件分岐を追加する
  - シェアボタンタップ時にシェアカードプレビュー画面に遷移する
  - タスク 5 のプレビュー画面に依存するため順次実行
  - _Requirements: 1.2, 1.3_

- [ ] 6.2 読了変更時にシェアを促す SnackBar を表示する
  - ReadingStatusModal で読了に変更完了後、シェアを促すアクション付き SnackBar を表示する
  - SnackBar のアクションボタンタップでシェアカードプレビュー画面に遷移する
  - 6.1 のシェアボタンと同じ遷移先を使用する
  - _Requirements: 1.1_

- [ ] 7. 結合テストとフロー検証
- [ ] 7.1* 読了からシェアまでの一連のフローをウィジェットテストで検証する
  - 読了変更後にシェア促進 SnackBar が表示されることを検証する
  - 読了状態でシェアボタンが表示され、非読了状態では非表示であることを検証する
  - シェア画面でカードレベル切り替えとプレビュー更新が正しく動作することを検証する
  - シェア・保存ボタンのローディング状態とエラーハンドリングを検証する
  - _Requirements: 1.1, 1.2, 1.3, 3.1, 3.3, 3.4, 4.4, 5.3, 5.4_
