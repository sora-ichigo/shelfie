# Implementation Plan

- [ ] 1. デバイストークンのデータベース基盤を構築する
- [ ] 1.1 デバイストークンテーブルのスキーマを定義する
  - ユーザーとデバイストークンの 1:N 関係を表現するテーブルを追加する
  - ユーザー ID とトークンの組み合わせにユニーク制約を設定し、重複登録を防止する
  - ユーザー削除時にトークンも連動して削除されるカスケード設定を含める
  - プラットフォーム（iOS / Android）を記録するカラムを含める
  - ユーザー ID による検索を高速化するインデックスを追加する
  - スキーマの集約エクスポートに新テーブルを登録する
  - _Requirements: 1.4_

- [ ] 1.2 データベースマイグレーションを生成・適用する
  - スキーマ定義からマイグレーションファイルを生成する
  - 開発環境にマイグレーションを適用し、テーブルが正しく作成されることを確認する
  - _Requirements: 1.4_

- [ ] 2. デバイストークンの永続化操作を実装する
- [ ] 2.1 デバイストークンリポジトリを実装する
  - トークン登録を UPSERT で冪等に処理し、同一ユーザー・同一トークンの場合は更新日時のみ更新する
  - ユーザー ID とトークンを指定した個別削除を実装する
  - トークン文字列のリストを指定した一括削除を実装する（無効トークン除去用）
  - ユーザー ID によるトークン検索、複数ユーザー ID によるトークン一括検索、全トークン取得をそれぞれ実装する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.3, 4.4_
  - _Contracts: DeviceTokenRepository Service_

- [ ] 2.2 デバイストークンリポジトリのユニットテストを作成する
  - UPSERT の冪等性（新規登録と更新の両方）を検証する
  - 各種検索メソッド（単一ユーザー、複数ユーザー、全件）の結果を検証する
  - 個別削除と一括削除の動作を検証する
  - ユーザー削除時のカスケード削除を検証する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.3, 4.4_

- [ ] 3. デバイストークン管理のビジネスロジックとGraphQL APIを実装する
- [ ] 3.1 デバイストークンサービスを実装する
  - トークン登録処理を実装し、リポジトリの UPSERT を呼び出す
  - トークン解除処理を実装し、指定ユーザーとトークンの組み合わせを削除する
  - 既存の Result 型パターンに従ったエラーハンドリングを実装する
  - _Requirements: 1.1, 1.2, 1.3, 1.4_
  - _Contracts: DeviceTokenService Service_

- [ ] 3.2 (P) デバイストークンサービスのユニットテストを作成する
  - リポジトリをモックし、登録成功・失敗のケースを検証する
  - 解除処理の正常系・異常系を検証する
  - _Requirements: 1.1, 1.2, 1.3_

- [ ] 3.3 デバイストークン管理の GraphQL Mutation を定義する
  - トークン登録 Mutation を実装し、トークン文字列とプラットフォームを受け取る
  - トークン解除 Mutation を実装し、トークン文字列を受け取って削除する
  - 認証済みユーザーのみがアクセスできるようスコープ設定を行う
  - 認証コンテキストからユーザー ID を取得してサービスに渡す
  - GraphQL スキーマ構築に新しい型定義を登録する
  - _Requirements: 1.1, 1.2, 1.3_
  - _Contracts: DeviceTokenGraphQL API_

- [ ] 3.4 (P) GraphQL Mutation の統合テストを作成する
  - 認証済みリクエストでトークン登録が成功することを検証する
  - 認証済みリクエストでトークン解除が成功することを検証する
  - 未認証リクエストが拒否されることを検証する
  - _Requirements: 1.1, 1.2, 1.3_

- [ ] 4. FCM 送信アダプターを実装する
- [ ] 4.1 FCM アダプターを実装する
  - firebase-admin の messaging API をラップし、マルチキャスト送信を実行する
  - 送信結果をパースし、成功数・失敗数・各トークンごとの結果を構造化データとして返却する
  - テスト時にモック可能なインターフェースとして設計する
  - _Requirements: 4.1, 4.2_
  - _Contracts: FCMAdapter Service_

- [ ] 4.2 (P) FCM アダプターのユニットテストを作成する
  - firebase-admin messaging をモックし、成功レスポンスのパースを検証する
  - 部分的な失敗（一部トークン成功・一部失敗）のレスポンスパースを検証する
  - _Requirements: 4.1, 4.2_

- [ ] 5. 通知送信ビジネスロジックを実装する
- [ ] 5.1 通知送信サービスを実装する
  - 全ユーザー対象の場合は全デバイストークンを取得し、ユーザー ID 指定の場合は該当ユーザーのトークンのみ取得する
  - 取得したトークンを 500 件ずつのバッチに分割し、FCM アダプターを通じて逐次送信する
  - 送信結果から無効トークン（登録解除済みトークン）を検出し、データベースから自動削除する
  - 送信失敗時のエラー情報をロガーで記録する
  - 送信結果（成功数、失敗数、削除トークン数、失敗詳細）を集計して返却する
  - 送信対象が 0 件の場合はエラーを返却する
  - タスク 2（リポジトリ）とタスク 4（FCM アダプター）の完了が前提
  - _Requirements: 2.1, 2.2, 2.3, 4.1, 4.2, 4.3, 4.4, 5.1, 5.2_
  - _Contracts: NotificationService Service_

- [ ] 5.2 通知送信サービスのユニットテストを作成する
  - リポジトリと FCM アダプターをモックし、全ユーザー対象の送信フローを検証する
  - 特定ユーザー ID 指定での送信フローを検証する
  - 500 件超のトークンがバッチ分割されることを検証する
  - 無効トークンが検出されてリポジトリの削除メソッドが呼ばれることを検証する
  - 送信対象 0 件でエラーが返却されることを検証する
  - _Requirements: 2.1, 2.2, 2.3, 4.1, 4.2, 4.3, 4.4_

- [ ] 6. API 側 Feature モジュールの Barrel Export を整備する
  - device-tokens Feature の公開 API を定義し、リポジトリ・サービス・GraphQL 型を re-export する
  - 既存の Feature モジュールパターン（index.ts 経由のアクセス）に従う
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [ ] 7. CLI スクリプトで通知送信機能を実装する
- [ ] 7.1 CLI 引数のパースとバリデーションを実装する
  - タイトル、本文、対象ユーザー指定（ユーザー ID リストまたは全ユーザーフラグ）の引数をパースする
  - タイトルと本文を必須とし、未指定時にエラーメッセージを表示して終了する
  - ユーザー ID リストと全ユーザーフラグの排他チェックを行い、両方指定または両方未指定時にエラーとする
  - _Requirements: 2.1, 2.2, 3.1, 3.2, 3.3_

- [ ] 7.2 通知送信の実行と結果出力を実装する
  - DB 接続と Firebase Admin の初期化を行う
  - バリデーション済みの引数で通知送信サービスを呼び出す
  - 送信結果（成功数・失敗数）をコンソールに出力する
  - 失敗があった場合はユーザー ID とエラー理由を個別に出力する
  - 処理完了後に DB 接続をクリーンアップして終了する
  - package.json にスクリプト実行用のコマンドを追加する
  - タスク 5（通知送信サービス）の完了が前提
  - _Requirements: 2.1, 2.2, 3.1, 3.2, 3.3, 5.1, 5.2_
  - _Contracts: CLI Script Batch_

- [ ] 7.3 (P) CLI スクリプトのユニットテストを作成する
  - 引数パースの各種パターン（正常系、必須引数不足、排他チェック違反）を検証する
  - 結果出力のフォーマットを検証する
  - _Requirements: 3.1, 3.2, 3.3, 5.1, 5.2_

- [ ] 8. モバイルアプリに Firebase Messaging を導入する
- [ ] 8.1 Firebase Messaging パッケージをセットアップする
  - firebase_core、firebase_messaging、flutter_local_notifications パッケージを追加する
  - FlutterFire CLI で firebase_options.dart を生成する
  - iOS の Push Notifications capability と Background Modes（Remote notifications）を有効化する
  - _Requirements: 6.1, 6.3_

- [ ] 8.2 アプリ起動時の通知初期化処理を実装する
  - アプリ起動時に通知許可をリクエストする処理を実装する
  - iOS のフォアグラウンド通知表示オプション（alert, badge, sound）を設定する
  - バックグラウンドメッセージハンドラを登録し、バックグラウンド通知をシステム通知として受信できるようにする
  - アプリのメインエントリーポイントに初期化処理を組み込む
  - _Requirements: 6.1, 6.3_
  - _Contracts: PushNotificationInitializer State_

- [ ] 8.3 フォアグラウンド通知の表示処理を実装する
  - FCM のフォアグラウンドメッセージストリームを監視し、受信時にネイティブ通知として表示する
  - Android 用の高優先度通知チャネルを作成し、heads-up 通知を表示する
  - notification が null のメッセージ（data-only）はスキップする
  - 通知初期化処理から呼び出されるように連携する
  - _Requirements: 6.2_
  - _Contracts: ForegroundNotificationHandler State_

- [ ] 9. モバイルアプリのデバイストークン同期を実装する
- [ ] 9.1 デバイストークン管理用の GraphQL Mutation を定義する
  - トークン登録とトークン解除の GraphQL Mutation ファイルを作成する
  - Ferry のコード生成を実行して型安全なクライアントコードを生成する
  - _Requirements: 1.1, 1.2, 1.3_

- [ ] 9.2 デバイストークン同期の Notifier を実装する
  - 認証状態の変化を監視し、ログイン時に FCM トークンを取得して API に登録する
  - トークン更新ストリームを監視し、更新時に API の登録情報を自動更新する
  - ログアウト時に API のトークン登録を解除する
  - FCM トークンが null の場合（通知許可拒否時）は登録をスキップする
  - ログアウト時のクリーンアップ処理に組み込む
  - _Requirements: 1.1, 1.2, 1.3_
  - _Contracts: DeviceTokenNotifier State_

- [ ]* 9.3 (P) デバイストークン同期のユニットテストを作成する
  - ログイン時のトークン登録フローを検証する
  - トークン更新時の再登録フローを検証する
  - ログアウト時のトークン解除フローを検証する
  - 通知許可拒否時にトークン登録がスキップされることを検証する
  - _Requirements: 1.1, 1.2, 1.3_

- [ ] 10. エンドツーエンドの統合検証を行う
- [ ] 10.1 API 側の通知送信統合テストを作成する
  - トークン登録からCLIによる通知送信、無効トークン削除までの一連のフローを検証する（FCM はモック）
  - 全ユーザー送信と特定ユーザー送信の両パターンを検証する
  - _Requirements: 1.1, 2.1, 2.2, 2.3, 4.1, 4.4_

- [ ] 10.2 (P) モバイル側の通知初期化・受信テストを作成する
  - 通知許可リクエストの呼び出しを検証する
  - フォアグラウンドメッセージ受信時の通知表示呼び出しを検証する
  - _Requirements: 6.1, 6.2, 6.3_
