# Implementation Plan

## Task 1: ドメインモデルの定義

- [x] 1.1 (P) 検索履歴エントリのデータモデルを作成する
  - freezed を使用してイミュータブルなデータクラスを定義
  - 検索クエリ文字列と検索日時を保持するフィールドを含める
  - JSON シリアライゼーションを実装（Hive 保存用）
  - コード生成（build_runner）を実行して .freezed.dart と .g.dart を生成
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [x] 1.2 (P) 最近チェックした本のデータモデルを作成する
  - freezed を使用してイミュータブルなデータクラスを定義
  - 書籍ID、タイトル、著者リスト、カバー画像URL（nullable）、閲覧日時を保持
  - JSON シリアライゼーションを実装（Hive 保存用）
  - コード生成（build_runner）を実行して .freezed.dart と .g.dart を生成
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

## Task 2: インフラストラクチャ層の実装

- [ ] 2.1 検索履歴リポジトリを実装する
  - Hive Box を使用した CRUD 操作を提供
  - 最大20件の履歴制限を強制するロジックを実装
  - 重複クエリの検出と日時更新のロジックを実装
  - 全履歴取得時に新しい順でソートして返却
  - Riverpod Provider を定義
  - Task 1.1 で作成したドメインモデルに依存
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 3.2, 3.3_

- [ ] 2.2 最近チェックした本リポジトリを実装する
  - Hive Box を使用した CRUD 操作を提供
  - 最大10件の履歴制限を強制するロジックを実装
  - 重複書籍IDの検出と日時更新のロジックを実装
  - 全履歴取得時に新しい順でソートして返却
  - Riverpod Provider を定義
  - Task 1.2 で作成したドメインモデルに依存
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [ ] 2.3 Hive 初期化処理を拡張する
  - main.dart の Hive 初期化フローに検索履歴用 Box のオープンを追加
  - main.dart の Hive 初期化フローに最近チェックした本用 Box のオープンを追加
  - Box 名の定数を定義
  - Task 2.1, 2.2 の実装完了後に統合
  - _Requirements: 1.1, 4.1_

## Task 3: アプリケーション層の実装

- [ ] 3.1 検索履歴 Notifier を実装する
  - AsyncNotifier を使用して検索履歴リストの状態を管理
  - 履歴追加、削除、全削除のメソッドを実装
  - 入力クエリに部分一致する履歴をフィルタリングするメソッドを実装
  - 空文字クエリは無視するバリデーションを実装
  - Repository 層への処理委譲
  - Task 2.1 の Repository に依存
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3, 2.4, 2.5, 3.2, 3.3_

- [ ] 3.2 最近チェックした本 Notifier を実装する
  - AsyncNotifier を使用して閲覧履歴リストの状態を管理
  - 履歴追加、削除、全削除のメソッドを実装
  - 必須フィールド（書籍ID、タイトル、著者）の存在確認バリデーションを実装
  - Repository 層への処理委譲
  - Task 2.2 の Repository に依存
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 5.1_

## Task 4: プレゼンテーション層の実装

- [ ] 4.1 検索履歴オーバーレイ UI コンポーネントを作成する
  - 検索フィールド下部にオーバーレイとして履歴候補を表示
  - 履歴が空の場合は非表示にする
  - 各履歴項目に Dismissible ウィジェットを適用し、左スワイプで削除ボタンを表示
  - 履歴項目タップ時のコールバックを定義
  - Task 3.1 の Notifier に依存
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 3.1, 3.2_

- [ ] 4.2 最近チェックした本セクション UI コンポーネントを作成する
  - 水平スクロール可能なリスト形式で表示
  - 各項目にカバー画像とタイトルを表示
  - カバー画像が利用できない場合はプレースホルダーアイコンを表示
  - 項目タップで本詳細画面へ遷移
  - 履歴が空の場合はセクション全体を非表示
  - Task 3.2 の Notifier に依存
  - _Requirements: 4.1, 4.2, 4.5, 5.1, 5.2, 5.3_

## Task 5: 既存コンポーネントの拡張

- [ ] 5.1 SearchScreen を拡張する
  - 検索フィールドに FocusNode を追加してフォーカス状態を監視
  - フォーカス時に検索履歴オーバーレイを表示
  - テキスト入力に応じて履歴フィルタリングを実行
  - フィールド外タップでオーバーレイを非表示にする GestureDetector を追加
  - 初期表示状態に最近チェックした本セクションを追加
  - 検索実行時に最近チェックした本セクションを非表示
  - 検索クリア時に初期表示状態に復帰
  - Task 4.1, 4.2 の UI コンポーネントに依存
  - _Requirements: 2.1, 4.1, 6.1, 6.2, 6.3_

- [ ] 5.2 BookSearchNotifier を拡張する
  - 検索成功時に検索履歴 Notifier の addHistory メソッドを呼び出し
  - ref.read を使用して SearchHistoryNotifier にアクセス
  - Task 3.1 の Notifier に依存
  - _Requirements: 1.1_

- [ ] 5.3 BookDetailScreen を拡張する
  - 画面表示時に最近チェックした本 Notifier の addRecentBook メソッドを呼び出し
  - 書籍詳細データ取得成功後に履歴を記録
  - ref.read を使用して RecentBooksNotifier にアクセス
  - Task 3.2 の Notifier に依存
  - _Requirements: 4.3_

## Task 6: ユニットテストの実装

- [x] 6.1 (P) ドメインモデルのテストを作成する
  - SearchHistoryEntry の JSON シリアライゼーション・デシリアライゼーションをテスト
  - RecentBookEntry の JSON シリアライゼーション・デシリアライゼーションをテスト
  - copyWith、equality、toString の動作を検証
  - _Requirements: 1.1, 4.1_

- [ ] 6.2 リポジトリ層のテストを作成する
  - SearchHistoryRepository の CRUD 操作をテスト
  - 最大20件制限の動作を検証
  - 重複クエリの更新動作を検証
  - RecentBooksRepository の CRUD 操作をテスト
  - 最大10件制限の動作を検証
  - 重複書籍IDの更新動作を検証
  - Task 2.1, 2.2 の実装に依存
  - _Requirements: 1.2, 1.3, 1.4, 4.2, 4.4_

- [ ] 6.3 Notifier 層のテストを作成する
  - SearchHistoryNotifier の状態管理をテスト
  - フィルタリングロジックの動作を検証
  - RecentBooksNotifier の状態管理をテスト
  - Task 3.1, 3.2 の実装に依存
  - _Requirements: 2.2, 2.3, 4.2_

## Task 7: ウィジェットテストの実装

- [ ]* 7.1 検索履歴オーバーレイのウィジェットテストを作成する
  - 履歴候補の表示・非表示切り替えを検証
  - 左スワイプ削除の動作を検証
  - 履歴項目タップ時のコールバック呼び出しを検証
  - Task 4.1 の実装に依存
  - _Requirements: 2.1, 2.4, 2.5, 3.1, 3.2_

- [ ]* 7.2 最近チェックした本セクションのウィジェットテストを作成する
  - アイテム表示の動作を検証
  - プレースホルダー画像の表示を検証
  - 項目タップ時の画面遷移を検証
  - 空状態での非表示を検証
  - Task 4.2 の実装に依存
  - _Requirements: 4.5, 5.1, 5.2, 5.3_

## Task 8: 統合テストの実装

- [ ]* 8. 主要フローの統合テストを作成する
  - 検索実行から履歴保存までのフローをテスト
  - 本詳細画面遷移から閲覧履歴記録までのフローをテスト
  - 履歴選択から検索実行までのフローをテスト
  - 全タスクの実装完了後に実施
  - _Requirements: 1.1, 2.4, 4.3_
